<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances / Lucca</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --accent: #18181b;
            --accent2: #3f3f46;
            --success: #16a34a;
            --danger: #dc2626;
            --invest: #6d28d9;
            --credit: #0284c7;
            --debit: #0f766e;
            --bg: #fafafa;
            --surface: #ffffff;
            --border: #e4e4e7;
            --border-light: #f4f4f5;
            --text: #18181b;
            --text-2: #52525b;
            --text-3: #a1a1aa;
            --sidebar-w: 300px;
            --radius: 10px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

        /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
        .topbar {
            height: 52px; background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; position: sticky; top: 0; z-index: 100; gap: 12px;
        }
        .topbar-left { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
        .logo { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; white-space: nowrap; }
        .logo span { color: var(--text-3); font-weight: 400; }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        .nav-pills { display: flex; gap: 2px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 3px; }
        .nav-pill { padding: 4px 13px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: none; font-family: 'Inter', sans-serif; color: var(--text-3); transition: all 0.15s; white-space: nowrap; }
        .nav-pill.active { background: var(--surface); color: var(--text); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-pill { font-size: 11px; font-weight: 500; color: var(--text-2); background: var(--bg); border: 1px solid var(--border); padding: 3px 10px; border-radius: 20px; white-space: nowrap; }
        .topbar-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .topbar select { border: 1px solid var(--border); background: var(--surface); padding: 5px 10px; border-radius: 7px; font-size: 12px; color: var(--text); font-family: 'Inter', sans-serif; outline: none; cursor: pointer; }
        .btn-undo { display: flex; align-items: center; gap: 5px; border: 1px solid var(--border); background: var(--surface); padding: 5px 12px; border-radius: 7px; font-size: 12px; font-weight: 500; color: var(--text-2); cursor: pointer; font-family: 'Inter', sans-serif; transition: background 0.1s; white-space: nowrap; }
        .btn-undo:hover:not(:disabled) { background: var(--bg); }
        .btn-undo:disabled { opacity: 0.35; cursor: default; }

        /* ‚îÄ‚îÄ DASHBOARD LAYOUT ‚îÄ‚îÄ */
        .app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; min-height: calc(100vh - 52px); }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); margin-bottom: 8px; }
        .field { margin-bottom: 8px; }
        .field label { font-size: 11px; font-weight: 500; color: var(--text-2); display: block; margin-bottom: 3px; }
        .field input, .field select { width: 100%; padding: 7px 10px; border: 1px solid var(--border); border-radius: 7px; font-size: 13px; font-family: 'Inter', sans-serif; color: var(--text); background: var(--surface); outline: none; transition: border-color 0.15s; }
        .field input:focus, .field select:focus { border-color: var(--accent); }
        .g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .check-row { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border: 1px solid var(--border); border-radius: 7px; font-size: 12px; font-weight: 500; color: var(--text-2); cursor: pointer; background: var(--bg); }
        .check-row input { width: auto; accent-color: var(--accent); }
        .btn-save { width: 100%; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 7px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; margin-top: 4px; transition: opacity 0.15s; }
        .btn-save:hover { opacity: 0.85; }
        .btn-cancel-edit { width: 100%; padding: 7px; background: var(--bg); color: var(--text-2); border: 1px solid var(--border); border-radius: 7px; font-size: 12px; font-weight: 500; cursor: pointer; font-family: 'Inter', sans-serif; margin-top: 4px; }
        .fixos-mini { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
        .fixos-mini-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .fixos-mini-total { font-size: 12px; font-weight: 700; color: var(--danger); }
        .fixos-mini-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border-light); font-size: 12px; }
        .fixos-mini-item:last-child { border-bottom: none; }
        .fixos-mini-item .n { color: var(--text); font-weight: 500; }
        .fixos-mini-item .v { color: var(--danger); font-weight: 600; }
        .link-btn { font-size: 11px; font-weight: 500; color: var(--text-3); background: none; border: none; cursor: pointer; padding: 0; font-family: 'Inter', sans-serif; text-decoration: underline; }
        .link-btn:hover { color: var(--text-2); }
        .cat-list { max-height: 100px; overflow-y: auto; margin-bottom: 8px; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border-light); font-size: 12px; }
        .add-cat { display: flex; gap: 6px; }
        .add-cat input { flex: 1; }
        .add-cat button { padding: 7px 12px; background: var(--accent); color: white; border: none; border-radius: 7px; cursor: pointer; font-size: 16px; }
        .backup-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .backup-btn { text-align: center; padding: 7px; border: 1px solid var(--border); border-radius: 7px; font-size: 12px; font-weight: 500; cursor: pointer; background: var(--surface); color: var(--text-2); transition: background 0.1s; }
        .backup-btn:hover { background: var(--bg); }

        /* ‚îÄ‚îÄ MAIN DASHBOARD ‚îÄ‚îÄ */
        .main { padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }

        /* ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ */
        .kpis { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; }
        .kpi { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
        .kpi.al-green  { border-left: 3px solid var(--success); }
        .kpi.al-red    { border-left: 3px solid var(--danger); }
        .kpi.al-purple { border-left: 3px solid var(--invest); }
        .kpi.al-blue   { border-left: 3px solid var(--credit); }
        .kpi.al-teal   { border-left: 3px solid var(--debit); }
        .kpi.al-dark   { border-left: 3px solid var(--accent); }
        .kpi-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-3); margin-bottom: 6px; }
        .kpi-val { font-size: 20px; font-weight: 700; line-height: 1; }
        .kpi-val.green  { color: var(--success); }
        .kpi-val.red    { color: var(--danger); }
        .kpi-val.purple { color: var(--invest); }
        .kpi-val.blue   { color: var(--credit); }
        .kpi-val.teal   { color: var(--debit); }
        .kpi-val.dark   { color: var(--text); }
        .kpi-sub { font-size: 11px; color: var(--text-3); margin-top: 4px; }
        .savings-track { height: 3px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .savings-fill  { height: 3px; background: var(--success); border-radius: 2px; transition: width 0.5s; }

        /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
        .charts { display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 12px; }
        .chart-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
        .chart-box-label { font-size: 11px; font-weight: 600; color: var(--text-2); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .chart-wrap { height: 160px; position: relative; }
        .chart-empty { height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-3); font-size: 12px; gap: 6px; }

        /* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
        .tag-cred { font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px; background: #e0f2fe; color: #0369a1; margin-left: 5px; vertical-align: middle; }
        .tag-deb  { font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px; background: #ccfbf1; color: #0f766e; margin-left: 5px; vertical-align: middle; }
        .tag-fixo { font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px; background: #fef3c7; color: #92400e; margin-left: 6px; vertical-align: middle; }

        /* ‚îÄ‚îÄ HISTORY TABLE ‚îÄ‚îÄ */
        .history-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .history-header { padding: 16px 16px 0; }
        .tabs { display: flex; gap: 2px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 3px; width: fit-content; margin-bottom: 14px; }
        .tab { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: none; font-family: 'Inter', sans-serif; color: var(--text-3); transition: all 0.15s; }
        .tab.active { background: var(--surface); color: var(--text); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab.active.t-entrada { color: var(--success); }
        .tab.active.t-saida   { color: var(--danger); }
        .tab.active.t-invest  { color: var(--invest); }
        .search-row { display: flex; gap: 8px; margin-bottom: 14px; }
        .search-row input { flex: 1; padding: 7px 10px; border: 1px solid var(--border); border-radius: 7px; font-size: 13px; font-family: 'Inter', sans-serif; outline: none; }
        .search-row input:focus { border-color: var(--accent); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-3); padding: 0 14px 10px; border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { color: var(--text-2); }
        th .si { margin-left: 3px; opacity: 0.4; }
        th.sort-asc .si, th.sort-desc .si { opacity: 1; color: var(--accent); }
        td { padding: 10px 14px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg); }
        .btn-row { display: flex; gap: 2px; justify-content: flex-end; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 13px; opacity: 0.35; padding: 3px 5px; border-radius: 4px; transition: opacity 0.15s; }
        .icon-btn:hover { opacity: 1; background: var(--bg); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-3); font-size: 13px; }

        /* ‚îÄ‚îÄ INLINE EDIT ROW ‚îÄ‚îÄ */
        .ie-row { display: none; background: #f8f8fa; }
        .ie-row.open { display: table-row; }
        .ie-row td { padding: 12px 14px; border-bottom: 1px solid var(--border); }
        .ie-inner { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 8px; align-items: end; }
        .ie-field { display: flex; flex-direction: column; gap: 3px; }
        .ie-field label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-3); }
        .ie-field input, .ie-field select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: 'Inter', sans-serif; color: var(--text); background: var(--surface); outline: none; }
        .ie-field input:focus, .ie-field select:focus { border-color: var(--accent); }
        .ie-actions { display: flex; gap: 4px; padding-bottom: 1px; }
        .ie-save { padding: 6px 14px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; white-space: nowrap; }
        .ie-cancel { padding: 6px 10px; background: var(--surface); color: var(--text-2); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; }
        .ie-check { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-2); margin-top: 6px; }
        .ie-check input { accent-color: var(--accent); }
        tr.editing > td { background: #f0f0f4 !important; }
        @media (max-width: 900px) { .ie-inner { grid-template-columns: 1fr 1fr 1fr; } }

        /* ‚îÄ‚îÄ GITHUB SYNC ‚îÄ‚îÄ */
        .gh-panel { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
        .gh-status { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; margin-bottom: 8px; }
        .gh-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .gh-dot.ok     { background: var(--success); }
        .gh-dot.err    { background: var(--danger); }
        .gh-dot.idle   { background: var(--text-3); }
        .gh-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .gh-config { display: none; flex-direction: column; gap: 6px; margin-top: 8px; }
        .gh-config.open { display: flex; }
        .gh-config input { width: 100%; padding: 6px 9px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: 'Inter', sans-serif; color: var(--text); background: var(--surface); outline: none; }
        .gh-config input:focus { border-color: var(--accent); }
        .gh-config input[type="password"] { letter-spacing: 0.1em; }
        .gh-btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 4px; }
        .gh-btn { padding: 6px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; border: none; text-align: center; }
        .gh-btn.primary { background: var(--accent); color: white; }
        .gh-btn.secondary { background: var(--surface); color: var(--text-2); border: 1px solid var(--border); }
        .gh-btn:hover { opacity: 0.85; }
        .gh-last-sync { font-size: 10px; color: var(--text-3); margin-top: 4px; }
        .gh-actions { display: flex; gap: 4px; }
        .gh-sync-btn { flex: 1; padding: 5px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; background: var(--accent); color: white; border: none; }
        .gh-sync-btn:hover { opacity: 0.85; }
        .gh-settings-btn { padding: 5px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; background: var(--surface); color: var(--text-3); border: 1px solid var(--border); }

        /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.18s; }
        .overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: var(--surface); border-radius: 14px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); transform: translateY(8px); transition: transform 0.18s; max-width: 95vw; }
        .overlay.open .modal { transform: translateY(0); }
        .modal-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
        .modal-sub { font-size: 12px; color: var(--text-3); margin-bottom: 16px; }
        .modal-footer { display: flex; gap: 8px; margin-top: 16px; }
        .modal-footer button { flex: 1; padding: 8px; border-radius: 7px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; border: none; }
        .btn-confirm  { background: var(--accent); color: white; }
        .btn-mcancel  { background: var(--bg); color: var(--text-2); border: 1px solid var(--border) !important; }
        #ovFixos .modal { width: 560px; max-height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .fixos-popup-head { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .fixos-popup-head h3 { font-size: 15px; font-weight: 700; }
        .fixos-total-pill { background: #fee2e2; color: var(--danger); font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
        .fixos-popup-body { overflow-y: auto; padding: 16px 24px; flex: 1; }
        .fixos-popup-item { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 6px; transition: background 0.1s; }
        .fixos-popup-item:hover { background: var(--bg); }
        .fp-name { font-weight: 600; font-size: 13px; }
        .fp-cat  { font-size: 11px; color: var(--text-3); margin-top: 2px; }
        .fp-val  { font-weight: 700; color: var(--danger); font-size: 13px; white-space: nowrap; }
        .fp-acts { display: flex; gap: 3px; }
        #ovEditFixo .modal, #ovNovaGoal .modal, #ovAporte .modal { width: 380px; }

        /* ‚ïê‚ïê FULL-WIDTH VIEWS ‚ïê‚ïê */
        .view { display: none; min-height: calc(100vh - 52px); }
        .view.active { display: block; }
        .view-inner { padding: 28px 32px; }
        .view-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 16px; }
        .view-title    { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
        .view-subtitle { font-size: 13px; color: var(--text-3); margin-top: 2px; }

        /* ‚îÄ‚îÄ ANNUAL VIEW ‚îÄ‚îÄ */
        .annual-kpis { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 14px; }
        .annual-charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-bottom: 20px; }
        .chart-wrap-tall { height: 240px; position: relative; }
        .chart-empty-tall { height: 240px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-3); font-size: 12px; gap: 6px; }
        .data-table-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .data-table-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-2); padding: 14px 16px; border-bottom: 1px solid var(--border); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-3); padding: 10px 14px; border-bottom: 1px solid var(--border); text-align: right; }
        .data-table th:first-child { text-align: left; }
        .data-table td { padding: 10px 14px; border-bottom: 1px solid var(--border-light); text-align: right; }
        .data-table td:first-child { text-align: left; font-weight: 500; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr.clickable:hover td { background: var(--bg); cursor: pointer; }
        .green-val  { color: var(--success); font-weight: 600; }
        .red-val    { color: var(--danger);  font-weight: 600; }
        .blue-val   { color: var(--credit);  font-weight: 600; }
        .teal-val   { color: var(--debit);   font-weight: 600; }
        .purple-val { color: var(--invest);  font-weight: 600; }

        /* ‚îÄ‚îÄ MONTHLY ANALYSIS VIEW ‚îÄ‚îÄ */
        .mensal-controls { display: flex; gap: 8px; }
        .mensal-controls select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 7px; font-size: 13px; font-family: 'Inter', sans-serif; outline: none; color: var(--text); }
        .split-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
        .split-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .split-head { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .split-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .split-title.debit  { color: var(--debit); }
        .split-title.credit { color: var(--credit); }
        .split-total { font-size: 18px; font-weight: 700; }
        .split-total.debit  { color: var(--debit); }
        .split-total.credit { color: var(--credit); }
        .split-list { max-height: 300px; overflow-y: auto; }
        .split-item { display: flex; justify-content: space-between; align-items: center; padding: 9px 16px; border-bottom: 1px solid var(--border-light); }
        .split-item:last-child { border-bottom: none; }
        .split-item-desc { font-weight: 500; font-size: 13px; }
        .split-item-meta { font-size: 11px; color: var(--text-3); margin-top: 1px; }
        .split-item-val  { font-weight: 600; color: var(--danger); font-size: 13px; white-space: nowrap; margin-left: 12px; }
        .split-empty { padding: 28px; text-align: center; color: var(--text-3); font-size: 12px; }
        .mensal-charts-row { display: grid; grid-template-columns: 1.6fr 1fr; gap: 14px; margin-bottom: 20px; }
        .chart-wrap-med { height: 200px; position: relative; }
        .cat-bar-list { padding: 4px 0; }
        .cat-bar-row { display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-bottom: 1px solid var(--border-light); }
        .cat-bar-row:last-child { border-bottom: none; }
        .cat-bar-name { font-size: 12px; font-weight: 500; width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0; }
        .cat-bar-track { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .cat-bar-fill  { height: 5px; border-radius: 3px; }
        .cat-bar-pct  { font-size: 11px; color: var(--text-3); width: 32px; text-align: right; flex-shrink: 0; }
        .cat-bar-val  { font-size: 12px; font-weight: 600; width: 90px; text-align: right; flex-shrink: 0; }

        /* ‚îÄ‚îÄ GOALS VIEW ‚îÄ‚îÄ */
        .goals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 16px; }
        .goal-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; transition: box-shadow 0.15s; }
        .goal-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.07); }
        .goal-accent { position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 12px 12px 0 0; }
        .goal-name  { font-size: 15px; font-weight: 700; margin-top: 10px; margin-bottom: 3px; }
        .goal-desc  { font-size: 12px; color: var(--text-3); margin-bottom: 14px; min-height: 16px; }
        .goal-amounts { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .goal-atual { font-size: 22px; font-weight: 700; }
        .goal-target { font-size: 13px; color: var(--text-3); }
        .goal-track  { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 6px; }
        .goal-fill   { height: 8px; border-radius: 4px; transition: width 0.6s; }
        .goal-meta-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-3); margin-bottom: 14px; }
        .goal-pct  { font-weight: 600; }
        .goal-actions { display: flex; gap: 4px; margin-left: auto; }
        .btn-aporte { width: 100%; padding: 7px; border: none; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; color: white; transition: opacity 0.15s; }
        .btn-aporte:hover { opacity: 0.88; }
        .goal-hist-toggle { font-size: 11px; color: var(--text-3); cursor: pointer; background: none; border: none; font-family: 'Inter', sans-serif; padding: 0; margin-top: 10px; text-decoration: underline; display: block; }
        .goal-history { margin-top: 10px; border-top: 1px solid var(--border-light); padding-top: 8px; display: none; }
        .goal-history.open { display: block; }
        .aporte-item { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; border-bottom: 1px solid var(--border-light); color: var(--text-2); }
        .aporte-item:last-child { border-bottom: none; }
        .goal-add-card { background: var(--bg); border: 2px dashed var(--border); border-radius: 12px; min-height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: border-color 0.15s; color: var(--text-3); }
        .goal-add-card:hover { border-color: var(--accent2); color: var(--text-2); }
        .color-picker { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
        .color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.15s, transform 0.1s; }
        .color-opt.selected { border-color: var(--text); transform: scale(1.15); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1100px) {
            .app { grid-template-columns: 1fr; }
            .charts { grid-template-columns: 1fr 1fr; }
            .kpis { grid-template-columns: 1fr 1fr; }
            .annual-kpis { grid-template-columns: 1fr 1fr; }
            .annual-charts-row { grid-template-columns: 1fr; }
            .mensal-charts-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .split-grid { grid-template-columns: 1fr; }
            .charts { grid-template-columns: 1fr; }
            .nav-pill { padding: 4px 9px; font-size: 11px; }
            .topbar { padding: 0 14px; gap: 8px; }
        }
        @media (max-width: 600px) {
            .kpis { grid-template-columns: 1fr 1fr; }
            .annual-kpis { grid-template-columns: 1fr 1fr; }
            .main, .view-inner { padding: 14px; }
            .sidebar { padding: 14px; }
        }
    </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-left">
        <div class="logo">Finances <span>/ Lucca</span></div>
        <nav class="nav-pills">
            <button class="nav-pill active" onclick="navTo('dashboard',this)">Dashboard</button>
            <button class="nav-pill" onclick="navTo('anual',this)">Anual</button>
            <button class="nav-pill" onclick="navTo('mensal',this)">Mensal</button>
            <button class="nav-pill" onclick="navTo('metas',this)">Metas</button>
        </nav>
        <div class="month-pill" id="pillMes">‚Äî</div>
    </div>
    <div class="topbar-right">
        <button class="btn-undo" id="btnUndo" onclick="undo()" disabled>‚Ü© Desfazer</button>
        <select id="filtroMes" onchange="onFiltroChange()"></select>
        <select id="filtroAno" onchange="onFiltroChange()"></select>
    </div>
</div>

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
<div id="view-dashboard" class="app">
    <aside class="sidebar">
        <div>
            <div class="section-label" id="formLabel">Novo Lan√ßamento</div>
            <input type="hidden" id="editId">
            <div class="field">
                <label>Descri√ß√£o</label>
                <input type="text" id="desc" placeholder="Ex: Supermercado">
            </div>
            <div class="g2">
                <div class="field">
                    <label>Valor (R$)</label>
                    <input type="text" id="valor" placeholder="0,00">
                </div>
                <div class="field">
                    <label>Data</label>
                    <input type="date" id="data">
                </div>
            </div>
            <div class="g2">
                <div class="field">
                    <label>Tipo</label>
                    <select id="tipo" onchange="carregarCats(); renderCatList(); togglePagamento()">
                        <option value="saida">üìâ Gasto</option>
                        <option value="entrada">üìà Ganho</option>
                        <option value="investimento">üü£ Investimento</option>
                    </select>
                </div>
                <div class="field">
                    <label>Categoria</label>
                    <select id="categoria"></select>
                </div>
            </div>
            <div class="field" id="pagamentoField">
                <label>Pagamento</label>
                <select id="pagamento">
                    <option value="debito">üü¢ D√©bito</option>
                    <option value="credito">üîµ Cr√©dito</option>
                </select>
            </div>
            <label class="check-row">
                <input type="checkbox" id="fixo"> Gasto fixo mensal?
            </label>
            <button class="btn-save" onclick="adicionar()">Salvar</button>
            <button class="btn-cancel-edit" id="btnCancelar" onclick="cancelarEdicao()" style="display:none">Cancelar edi√ß√£o</button>
        </div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>
            <div class="section-label">Gastos Fixos</div>
            <div class="fixos-mini">
                <div class="fixos-mini-header">
                    <span id="fixosMiniTotal" class="fixos-mini-total"></span>
                    <button class="link-btn" onclick="abrirPopupFixos()">Gerenciar ‚Üí</button>
                </div>
                <div id="fixosMiniList"><span style="font-size:12px;color:var(--text-3)">Nenhum fixo neste m√™s.</span></div>
            </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>
            <div class="section-label">Categorias</div>
            <div class="cat-list" id="catList"></div>
            <div class="add-cat">
                <input type="text" id="novaCat" placeholder="Nova categoria..." class="field" style="margin:0">
                <button onclick="adicionarCategoria()">Ôºã</button>
            </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>
            <div class="section-label">GitHub Sync</div>
            <div class="gh-panel">
                <div class="gh-status">
                    <div class="gh-dot idle" id="ghDot"></div>
                    <span id="ghStatusText">N√£o configurado</span>
                </div>
                <div class="gh-actions">
                    <button class="gh-sync-btn" onclick="syncNow()">‚Üª Sincronizar</button>
                    <button class="gh-settings-btn" onclick="toggleGhConfig()">‚öô</button>
                </div>
                <div class="gh-last-sync" id="ghLastSync"></div>
                <div class="gh-config" id="ghConfig">
                    <div class="field" style="margin:0">
                        <label style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);display:block;margin-bottom:3px">Usu√°rio/Reposit√≥rio</label>
                        <input type="text" id="ghRepo" placeholder="usuario/nome-do-repo">
                    </div>
                    <div class="field" style="margin:0">
                        <label style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);display:block;margin-bottom:3px">Token (PAT)</label>
                        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                    <div class="field" style="margin:0">
                        <label style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-3);display:block;margin-bottom:3px">Arquivo no repo</label>
                        <input type="text" id="ghFile" placeholder="finances-data.json">
                    </div>
                    <div class="gh-btn-row">
                        <button class="gh-btn secondary" onclick="toggleGhConfig()">Cancelar</button>
                        <button class="gh-btn primary" onclick="saveGhConfig()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div>
            <div class="section-label">Backup Local</div>
            <div class="backup-row">
                <div class="backup-btn" onclick="exportar()">‚Üí Exportar</div>
                <label class="backup-btn">‚Üì Importar<input type="file" hidden onchange="importar(this)"></label>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="kpis">
            <div class="kpi">
                <div class="kpi-label">Entradas</div>
                <div class="kpi-val green" id="kpiEnt">‚Äî</div>
                <div class="kpi-sub" id="kpiEntSub"></div>
            </div>
            <div class="kpi">
                <div class="kpi-label">Despesas</div>
                <div class="kpi-val red" id="kpiGas">‚Äî</div>
                <div class="kpi-sub" id="kpiGasSub"></div>
            </div>
            <div class="kpi">
                <div class="kpi-label">Investido</div>
                <div class="kpi-val purple" id="kpiInv">‚Äî</div>
            </div>
            <div class="kpi" id="kpiSalCard">
                <div class="kpi-label">Saldo</div>
                <div class="kpi-val dark" id="kpiSal">‚Äî</div>
                <div id="savingsWrap" style="display:none">
                    <div class="kpi-sub" id="savingsLabel"></div>
                    <div class="savings-track"><div class="savings-fill" id="savingsFill" style="width:0%"></div></div>
                </div>
            </div>
        </div>
        <div class="charts">
            <div class="chart-box">
                <div class="chart-box-label">Despesas por Categoria</div>
                <div id="wrapGastos"><div class="chart-empty"><span style="font-size:24px;opacity:.3">üìâ</span>Sem dados</div></div>
            </div>
            <div class="chart-box">
                <div class="chart-box-label">Investimentos</div>
                <div id="wrapInvest"><div class="chart-empty"><span style="font-size:24px;opacity:.3">üíº</span>Sem dados</div></div>
            </div>
            <div class="chart-box">
                <div class="chart-box-label">Tend√™ncia ‚Äî 6 meses</div>
                <div class="chart-wrap"><canvas id="graficoTrend"></canvas></div>
            </div>
        </div>
        <div class="history-box">
            <div class="history-header">
                <div class="tabs">
                    <button class="tab active" id="tab-all"    onclick="setTab('all')">Todos</button>
                    <button class="tab t-entrada" id="tab-entrada" onclick="setTab('entrada')">Entradas</button>
                    <button class="tab t-saida"   id="tab-saida"   onclick="setTab('saida')">Sa√≠das</button>
                    <button class="tab t-invest"  id="tab-invest"  onclick="setTab('investimento')">Investimentos</button>
                </div>
                <div class="search-row">
                    <input type="text" id="busca" placeholder="Buscar..." oninput="renderTabela()">
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortBy('data')">Data <i class="si" id="si-data">‚Üï</i></th>
                        <th class="sortable" onclick="sortBy('desc')">Descri√ß√£o <i class="si" id="si-desc">‚Üï</i></th>
                        <th class="sortable" onclick="sortBy('cat')">Categoria <i class="si" id="si-cat">‚Üï</i></th>
                        <th class="sortable" onclick="sortBy('valor')">Valor <i class="si" id="si-valor">‚Üï</i></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
            <div id="emptyState" style="display:none" class="empty-state">Nenhum lan√ßamento encontrado.</div>
        </div>
    </main>
</div>

<!-- ‚ïê‚ïê VIS√ÉO ANUAL ‚ïê‚ïê -->
<div id="view-anual" class="view">
    <div class="view-inner">
        <div class="view-header">
            <div>
                <div class="view-title">Vis√£o Anual</div>
                <div class="view-subtitle" id="anualSubtitle">Resumo completo do ano</div>
            </div>
        </div>
        <div class="annual-kpis" style="grid-template-columns:repeat(6,1fr)">
            <div class="kpi al-green">  <div class="kpi-label">Entradas</div>  <div class="kpi-val green"  id="aKpiEnt">‚Äî</div></div>
            <div class="kpi al-red">    <div class="kpi-label">Despesas</div>  <div class="kpi-val red"    id="aKpiGas">‚Äî</div></div>
            <div class="kpi al-teal">   <div class="kpi-label">D√©bito</div>    <div class="kpi-val teal"   id="aKpiDeb">‚Äî</div><div class="kpi-sub" id="aKpiDebPct"></div></div>
            <div class="kpi al-blue">   <div class="kpi-label">Cr√©dito</div>   <div class="kpi-val blue"   id="aKpiCred">‚Äî</div><div class="kpi-sub" id="aKpiCredPct"></div></div>
            <div class="kpi al-purple"> <div class="kpi-label">Investido</div> <div class="kpi-val purple" id="aKpiInv">‚Äî</div></div>
            <div class="kpi al-dark">   <div class="kpi-label">Saldo</div>     <div class="kpi-val dark"   id="aKpiSaldo">‚Äî</div></div>
        </div>
        <div class="annual-charts-row">
            <div class="chart-box">
                <div class="chart-box-label">Fluxo Mensal</div>
                <div class="chart-wrap-tall"><canvas id="graficoAnual"></canvas></div>
            </div>
            <div class="chart-box">
                <div class="chart-box-label">Despesas por Categoria</div>
                <div id="wrapAnualCat"><div class="chart-empty-tall"><span style="font-size:24px;opacity:.3">üìâ</span>Sem dados</div></div>
            </div>
        </div>
        <div class="data-table-box">
            <div class="data-table-title">M√™s a M√™s ‚Äî clique para ver detalhe</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="text-align:left">M√™s</th>
                        <th>Entradas</th>
                        <th>D√©bito</th>
                        <th>Cr√©dito</th>
                        <th>Investido</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="anualTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê AN√ÅLISE MENSAL ‚ïê‚ïê -->
<div id="view-mensal" class="view">
    <div class="view-inner">
        <div class="view-header">
            <div>
                <div class="view-title">An√°lise Mensal</div>
                <div class="view-subtitle">Detalhamento cr√©dito, d√©bito e categorias</div>
            </div>
            <div class="mensal-controls">
                <select id="mensalMes" onchange="renderMensal()"></select>
                <select id="mensalAno" onchange="renderMensal()"></select>
            </div>
        </div>
        <div class="kpis" style="margin-bottom:20px">
            <div class="kpi"><div class="kpi-label">Entradas</div><div class="kpi-val green" id="mKpiEnt">‚Äî</div></div>
            <div class="kpi"><div class="kpi-label">Despesas</div><div class="kpi-val red"   id="mKpiGas">‚Äî</div><div class="kpi-sub" id="mKpiGasSub"></div></div>
            <div class="kpi"><div class="kpi-label">No D√©bito</div><div class="kpi-val teal" id="mKpiDeb">‚Äî</div></div>
            <div class="kpi"><div class="kpi-label">No Cr√©dito</div><div class="kpi-val blue" id="mKpiCred">‚Äî</div></div>
        </div>
        <div class="split-grid">
            <div class="split-box">
                <div class="split-head">
                    <span class="split-title debit">üü¢ Compras no D√©bito</span>
                    <span class="split-total debit" id="mDebTotal">R$ 0</span>
                </div>
                <div class="split-list" id="mDebList"></div>
            </div>
            <div class="split-box">
                <div class="split-head">
                    <span class="split-title credit">üîµ Compras no Cr√©dito</span>
                    <span class="split-total credit" id="mCredTotal">R$ 0</span>
                </div>
                <div class="split-list" id="mCredList"></div>
            </div>
        </div>
        <div class="mensal-charts-row">
            <div class="chart-box">
                <div class="chart-box-label">Gastos por Dia</div>
                <div class="chart-wrap-med"><canvas id="graficoDia"></canvas></div>
            </div>
            <div class="chart-box">
                <div class="chart-box-label">D√©bito vs Cr√©dito</div>
                <div class="chart-wrap-med"><canvas id="graficoCvD"></canvas></div>
            </div>
        </div>
        <div class="data-table-box">
            <div class="data-table-title">Gastos por Categoria</div>
            <div class="cat-bar-list" id="catBreakdownList"></div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê METAS DE POUPAN√áA ‚ïê‚ïê -->
<div id="view-metas" class="view">
    <div class="view-inner">
        <div class="view-header">
            <div>
                <div class="view-title">Metas de Poupan√ßa</div>
                <div class="view-subtitle">Objetivos de longo prazo e acompanhamento</div>
            </div>
            <button class="btn-save" style="width:auto;padding:8px 18px;margin-top:0" onclick="abrirNovaGoal()">+ Nova Meta</button>
        </div>
        <div class="goals-grid" id="goalsGrid"></div>
    </div>
</div>

<!-- ‚ïê‚ïê POPUP FIXOS ‚ïê‚ïê -->
<div class="overlay" id="ovFixos" onclick="closeFixos(event)">
    <div class="modal">
        <div class="fixos-popup-head">
            <div>
                <h3>Gastos Fixos</h3>
                <div style="font-size:11px;color:var(--text-3);margin-top:2px" id="fixosPopupMes"></div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <div class="fixos-total-pill" id="fixosPopupTotal"></div>
                <button class="icon-btn" onclick="closeFixos()" style="font-size:16px;opacity:0.4">‚úï</button>
            </div>
        </div>
        <div class="fixos-popup-body" id="fixosPopupBody"></div>
    </div>
</div>

<!-- ‚ïê‚ïê MODAL EDITAR FIXO ‚ïê‚ïê -->
<div class="overlay" id="ovEditFixo" onclick="closeEditFixo(event)">
    <div class="modal">
        <div class="modal-title">Editar Gasto Fixo</div>
        <div class="modal-sub" id="editFixoNome"></div>
        <div class="field">
            <label>Novo Valor (R$)</label>
            <input type="text" id="editFixoVal" placeholder="0,00">
        </div>
        <div class="field">
            <label>Categoria</label>
            <select id="editFixoCat"></select>
        </div>
        <label class="check-row" style="margin-top:4px">
            <input type="checkbox" id="editFixoFuturo"> Atualizar meses futuros tamb√©m?
        </label>
        <div class="modal-footer">
            <button class="btn-mcancel" onclick="closeEditFixo()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmarEdicaoFixo()">Salvar</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê MODAL NOVA/EDITAR META ‚ïê‚ïê -->
<div class="overlay" id="ovNovaGoal" onclick="closeNovaGoal(event)">
    <div class="modal">
        <div class="modal-title" id="goalModalTitle">Nova Meta</div>
        <input type="hidden" id="goalEditId">
        <div class="field">
            <label>Nome da meta</label>
            <input type="text" id="goalNome" placeholder="Ex: Fundo de emerg√™ncia">
        </div>
        <div class="g2">
            <div class="field">
                <label>Valor alvo (R$)</label>
                <input type="number" id="goalMeta" placeholder="10000" min="1">
            </div>
            <div class="field">
                <label>Prazo</label>
                <input type="date" id="goalPrazo">
            </div>
        </div>
        <div class="field">
            <label>Descri√ß√£o (opcional)</label>
            <input type="text" id="goalDesc" placeholder="Ex: 6 meses de despesas">
        </div>
        <div class="field">
            <label>Cor</label>
            <div class="color-picker" id="colorPicker"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-mcancel" onclick="closeNovaGoal()">Cancelar</button>
            <button class="btn-confirm" onclick="salvarGoal()">Salvar Meta</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê MODAL APORTE ‚ïê‚ïê -->
<div class="overlay" id="ovAporte" onclick="closeAporte(event)">
    <div class="modal">
        <div class="modal-title">Adicionar Aporte</div>
        <div class="modal-sub" id="aporteGoalNome"></div>
        <input type="hidden" id="aporteGoalId">
        <div class="g2">
            <div class="field">
                <label>Valor (R$)</label>
                <input type="number" id="aporteValor" placeholder="500" min="0.01" step="0.01">
            </div>
            <div class="field">
                <label>Data</label>
                <input type="date" id="aporteData">
            </div>
        </div>
        <div class="field">
            <label>Nota (opcional)</label>
            <input type="text" id="aporteNota" placeholder="Ex: Sal√°rio de mar√ßo">
        </div>
        <div class="modal-footer">
            <button class="btn-mcancel" onclick="closeAporte()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmarAporte()">Adicionar</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê MODAL FIXO REPLICAR ‚ïê‚ïê -->
<div class="overlay" id="ovFixoRep" onclick="if(event.target===this) closeFixoRep('nao')">
    <div class="modal" style="max-width:360px;width:360px">
        <div class="modal-title">üìå Gasto Fixo</div>
        <div class="modal-sub" id="fixoRepMsg">Deseja replicar este gasto para os pr√≥ximos meses do ano?</div>
        <div class="modal-footer">
            <button class="btn-mcancel" onclick="closeFixoRep('nao')">S√≥ este m√™s</button>
            <button class="btn-confirm" onclick="closeFixoRep('sim')">Replicar at√© Dez</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div id="toast" style="position:fixed;bottom:20px;right:20px;background:#18181b;color:white;padding:10px 16px;border-radius:8px;font-size:12px;font-weight:500;opacity:0;transform:translateY(6px);transition:all 0.25s;pointer-events:none;z-index:999;"></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEED = [
    {id:1, desc:"Aluguel",        valor:1800, data:"2026-02-01", tipo:"saida",        cat:"üè† Moradia",       fixo:true,  pagamento:"debito"},
    {id:2, desc:"Netflix",         valor:44.9, data:"2026-02-01", tipo:"saida",        cat:"üì± Assinaturas",  fixo:true,  pagamento:"credito"},
    {id:3, desc:"Sal√°rio",         valor:5500, data:"2026-02-05", tipo:"entrada",       cat:"üí∞ Sal√°rio",       fixo:false, pagamento:null},
    {id:4, desc:"Supermercado",    valor:380,  data:"2026-02-08", tipo:"saida",        cat:"üçî Alimenta√ß√£o",   fixo:false, pagamento:"debito"},
    {id:5, desc:"Tesouro Direto",  valor:600,  data:"2026-02-10", tipo:"investimento",  cat:"üõ°Ô∏è Renda Fixa",  fixo:false, pagamento:null},
    {id:6, desc:"Restaurante",     valor:95,   data:"2026-02-12", tipo:"saida",        cat:"üçΩÔ∏è Restaurantes", fixo:false, pagamento:"credito"},
    {id:7, desc:"Uber",            valor:38,   data:"2026-02-14", tipo:"saida",        cat:"üöó Transporte",    fixo:false, pagamento:"credito"},
    {id:8, desc:"Farm√°cia",        valor:62,   data:"2026-02-15", tipo:"saida",        cat:"üíä Sa√∫de",         fixo:false, pagamento:"debito"}
];
if (!localStorage.getItem('fin5_data')) localStorage.setItem('fin5_data', JSON.stringify(SEED));

let tx = JSON.parse(localStorage.getItem('fin5_data'));
// Backward compat: add pagamento field if missing
tx = tx.map(t => ({pagamento: t.tipo==='saida' ? 'debito' : null, ...t}));

let cats = JSON.parse(localStorage.getItem('fin5_cats')) || {
    saida:        ["üè† Moradia","üçî Alimenta√ß√£o","üöó Transporte","üéâ Lazer","üíä Sa√∫de","üõí Compras","üí≥ Fatura Cart√£o","üë®‚Äçüë©‚Äçüëß Fam√≠lia","üì° Internet/Telefone","üì± Assinaturas","üçΩÔ∏è Restaurantes","üéÆ Jogos","üëó Roupas"],
    entrada:      ["üí∞ Sal√°rio","üí∏ Dividendos","üë®‚Äçüë©‚Äçüëß Fam√≠lia","üîÑ Transfer√™ncia","‚öôÔ∏è Outros"],
    investimento: ["üõ°Ô∏è Renda Fixa","üìà A√ß√µes","‚Çø Cripto","üè¶ Fundo"]
};
let goals = JSON.parse(localStorage.getItem('fin5_goals')) || [];

let undoStack = [];
let sortCol = 'data', sortDir = 'desc';
let activeTab = 'all';
let editingFixoNome = null;
let charts = {};
let currentView = 'dashboard';
let selectedGoalColor = '#16a34a';

const MESES = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const GOAL_COLORS = ['#16a34a','#0284c7','#6d28d9','#dc2626','#f59e0b','#ec4899','#0f766e','#b45309','#0e7490'];
const CAT_COLORS  = ['#ef4444','#f59e0b','#3b82f6','#10b981','#ec4899','#8b5cf6','#06b6d4','#84cc16','#f97316','#14b8a6'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
    const now = new Date();
    // Top filters
    const sm = document.getElementById('filtroMes'), sa = document.getElementById('filtroAno');
    MESES.forEach((m,i) => { const o=document.createElement('option'); o.value=i; o.text=m; if(i===now.getMonth()) o.selected=true; sm.add(o); });
    for (let y=now.getFullYear()-3; y<=now.getFullYear()+2; y++) { const o=document.createElement('option'); o.value=y; o.text=y; if(y===now.getFullYear()) o.selected=true; sa.add(o); }
    // Mensal selectors
    const mm = document.getElementById('mensalMes'), ma = document.getElementById('mensalAno');
    MESES.forEach((m,i) => { const o=document.createElement('option'); o.value=i; o.text=m; if(i===now.getMonth()) o.selected=true; mm.add(o); });
    for (let y=now.getFullYear()-3; y<=now.getFullYear()+2; y++) { const o=document.createElement('option'); o.value=y; o.text=y; if(y===now.getFullYear()) o.selected=true; ma.add(o); }

    document.getElementById('data').valueAsDate = now;
    document.getElementById('aporteData').valueAsDate = now;
    carregarCats(); renderCatList(); togglePagamento(); atualizar(); renderGoals();
    document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key==='z') { e.preventDefault(); undo(); } });
    initGhStatus();
    loadFromGitHub();
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function navTo(view, btn) {
    currentView = view;
    document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
    if (btn) btn.classList.add('active');

    const isDash = view === 'dashboard';
    document.getElementById('view-dashboard').style.display = isDash ? 'grid' : 'none';
    ['anual','mensal','metas'].forEach(v => {
        document.getElementById('view-'+v).classList.toggle('active', v===view);
    });

    // Hide month selector on views where it's irrelevant
    const hideMes = (view === 'anual' || view === 'metas');
    document.getElementById('filtroMes').style.display = hideMes ? 'none' : '';
    document.getElementById('pillMes').style.display   = hideMes ? 'none' : '';

    if (view === 'anual')   renderAnual();
    if (view === 'mensal')  renderMensal();
    if (view === 'metas')   renderGoals();
}

function onFiltroChange() {
    atualizar();
    if (currentView === 'mensal') renderMensal();
}

function goToMensal(m, a) {
    document.getElementById('mensalMes').value = m;
    document.getElementById('mensalAno').value = a;
    const btn = document.querySelectorAll('.nav-pill')[2];
    navTo('mensal', btn);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt    = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const filtro = () => ({m: parseInt(document.getElementById('filtroMes').value), a: parseInt(document.getElementById('filtroAno').value)});
const txMes  = (m,a) => tx.filter(t => { const d=new Date(t.data+'T00:00:00'); return d.getMonth()===m && d.getFullYear()===a; });
const save   = () => { localStorage.setItem('fin5_data', JSON.stringify(tx)); scheduleGhSave(); };
const saveGoals = () => { localStorage.setItem('fin5_goals', JSON.stringify(goals)); scheduleGhSave(); };

function toast(msg, bg='#18181b') {
    const el=document.getElementById('toast'); el.textContent=msg; el.style.background=bg;
    el.style.opacity=1; el.style.transform='translateY(0)';
    setTimeout(()=>{ el.style.opacity=0; el.style.transform='translateY(6px)'; }, 2400);
}

// ‚îÄ‚îÄ UNDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pushUndo(snap, label) {
    undoStack.push({snap: JSON.parse(JSON.stringify(snap)), label});
    if (undoStack.length > 30) undoStack.shift();
    const b=document.getElementById('btnUndo'); b.disabled=false; b.title=`Desfazer: ${label}`;
}
function undo() {
    if (!undoStack.length) return;
    const {snap, label} = undoStack.pop();
    tx=snap; save(); atualizar();
    toast(`‚Ü© Desfeito: ${label}`,'#6d28d9');
    document.getElementById('btnUndo').disabled = undoStack.length===0;
}

// ‚îÄ‚îÄ SORTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sortBy(col) {
    if (sortCol===col) sortDir = sortDir==='asc'?'desc':'asc';
    else { sortCol=col; sortDir = col==='valor'?'desc':'asc'; }
    ['data','desc','cat','valor'].forEach(c => {
        const el=document.getElementById('si-'+c), th=el.closest('th');
        el.textContent='‚Üï'; th.classList.remove('sort-asc','sort-desc');
    });
    const si=document.getElementById('si-'+col);
    si.textContent = sortDir==='asc'?'‚Üë':'‚Üì';
    si.closest('th').classList.add(sortDir==='asc'?'sort-asc':'sort-desc');
    renderTabela();
}
function sorted(list) {
    return [...list].sort((a,b) => {
        let va,vb;
        if (sortCol==='data')  {va=a.data; vb=b.data;}
        if (sortCol==='desc')  {va=a.desc.toLowerCase(); vb=b.desc.toLowerCase();}
        if (sortCol==='cat')   {va=a.cat.toLowerCase();  vb=b.cat.toLowerCase();}
        if (sortCol==='valor') {va=a.valor; vb=b.valor;}
        return sortDir==='asc'?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0);
    });
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    const map = {all:'tab-all', entrada:'tab-entrada', saida:'tab-saida', investimento:'tab-invest'};
    document.getElementById(map[tab]).classList.add('active');
    renderTabela();
}

// ‚îÄ‚îÄ PAGAMENTO TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePagamento() {
    document.getElementById('pagamentoField').style.display = document.getElementById('tipo').value==='saida' ? '' : 'none';
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function carregarCats() {
    const tipo=document.getElementById('tipo').value, sel=document.getElementById('categoria');
    sel.innerHTML='';
    (cats[tipo]||[]).forEach(c => { const o=document.createElement('option'); o.value=c; o.text=c; sel.add(o); });
}

// Pending fixo data while modal is open
let _pendingFixo = null;

function adicionar() {
    const idEd  = document.getElementById('editId').value;
    const desc  = document.getElementById('desc').value.trim();
    const valor = parseFloat(document.getElementById('valor').value.replace(/\./g,'').replace(',','.'));
    const data  = document.getElementById('data').value;
    const tipo  = document.getElementById('tipo').value;
    const cat   = document.getElementById('categoria').value;
    const fixo  = document.getElementById('fixo').checked;
    const pagamento = tipo==='saida' ? document.getElementById('pagamento').value : null;

    if (!desc)                   return toast('‚ö†Ô∏è Digite uma descri√ß√£o.','#b45309');
    if (isNaN(valor)||valor<=0)  return toast('‚ö†Ô∏è Valor inv√°lido.','#b45309');
    if (!data)                   return toast('‚ö†Ô∏è Selecione uma data.','#b45309');

    pushUndo(tx, idEd ? `Edi√ß√£o de "${desc}"` : `Adi√ß√£o de "${desc}"`);

    if (idEd) {
        const oldT = tx.find(t=>t.id==idEd);
        tx = tx.map(t => t.id==idEd ? {...t,desc,valor,data,tipo,cat,fixo,pagamento} : t);
        // If fixo was newly checked during edit, offer replication
        if (fixo && !oldT.fixo) {
            _pendingFixo = {desc,valor,data,tipo,cat,pagamento,afterEditId:idEd};
            document.getElementById('fixoRepMsg').textContent = `"${desc}" foi marcado como fixo. Replicar para os pr√≥ximos meses?`;
            document.getElementById('ovFixoRep').classList.add('open');
            return; // closeFixoRep will finalize
        }
        toast('‚úî Atualizado!'); cancelarEdicao();
    } else {
        if (fixo) {
            _pendingFixo = {desc,valor,data,tipo,cat,pagamento,afterEditId:null};
            document.getElementById('fixoRepMsg').textContent = `Replicar "${desc}" como gasto fixo para os pr√≥ximos meses?`;
            document.getElementById('ovFixoRep').classList.add('open');
            return; // closeFixoRep will finalize
        }
        tx.push({id: Date.now(), desc, valor, data, tipo, cat, fixo: false, pagamento});
        toast('‚úî Salvo!');
    }
    _finalizarAdicionar();
}

function closeFixoRep(opcao) {
    document.getElementById('ovFixoRep').classList.remove('open');
    if (!_pendingFixo) return;
    const {desc,valor,data,tipo,cat,pagamento,afterEditId} = _pendingFixo;
    _pendingFixo = null;

    if (opcao === 'sim') {
        const d = new Date(data+'T00:00:00');
        const base = Date.now();
        for (let i = d.getMonth(); i <= 11; i++) {
            const nd = new Date(d.getFullYear(), i, d.getDate());
            tx.push({id: base + (i * 1000), desc, valor, data: nd.toISOString().split('T')[0], tipo, cat, fixo: true, pagamento});
        }
        // Remove the old single entry if it was an edit-to-fixo case
        if (afterEditId) tx = tx.filter(t => t.id != afterEditId);
        toast('üìå Fixo replicado at√© Dezembro!');
    } else {
        if (!afterEditId) {
            tx.push({id: Date.now(), desc, valor, data, tipo, cat, fixo: true, pagamento});
        }
        toast('‚úî Salvo como fixo (s√≥ este m√™s).');
    }
    _finalizarAdicionar();
}

function _finalizarAdicionar() {
    save(); atualizar();
    document.getElementById('desc').value='';
    document.getElementById('valor').value='';
    cancelarEdicao();
}

function cancelarEdicao() {
    document.getElementById('editId').value='';
    document.getElementById('formLabel').textContent='Novo Lan√ßamento';
    document.getElementById('btnCancelar').style.display='none';
    document.getElementById('desc').value='';
    document.getElementById('valor').value='';
}

function remover(id) {
    const t=tx.find(x=>x.id==id);
    if (!confirm(`Remover "${t.desc}"?`)) return;
    pushUndo(tx, `Remo√ß√£o de "${t.desc}"`);
    tx=tx.filter(x=>x.id!=id); save(); atualizar();
    toast('Removido.','#52525b');
}

// ‚îÄ‚îÄ FIXOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirPopupFixos() { renderPopupFixos(); document.getElementById('ovFixos').classList.add('open'); }
function closeFixos(e) { if (!e||e.target===document.getElementById('ovFixos')) document.getElementById('ovFixos').classList.remove('open'); }

function renderPopupFixos() {
    const {m,a}=filtro(), lista=txMes(m,a);
    const fixosMap={}, fixosCat={};
    lista.forEach(t => { if(t.fixo){ fixosMap[t.desc]=(fixosMap[t.desc]||0)+t.valor; fixosCat[t.desc]=t.cat; } });
    const nomes=Object.keys(fixosMap), total=Object.values(fixosMap).reduce((s,v)=>s+v,0);
    document.getElementById('fixosPopupMes').textContent = MESES[m]+' / '+a;
    document.getElementById('fixosPopupTotal').textContent = fmt(total);
    const body=document.getElementById('fixosPopupBody');
    if (!nomes.length) { body.innerHTML='<div class="empty-state">Nenhum fixo neste m√™s.</div>'; return; }
    body.innerHTML = nomes.sort((a,b)=>fixosMap[b]-fixosMap[a]).map(nome=>`
        <div class="fixos-popup-item">
            <div><div class="fp-name">${nome}</div><div class="fp-cat">${fixosCat[nome]}</div></div>
            <div class="fp-val">${fmt(fixosMap[nome])}</div>
            <div class="fp-acts">
                <button class="icon-btn" onclick="abrirEditFixo('${nome.replace(/'/g,"\\'")}','${fixosCat[nome].replace(/'/g,"\\'")}')">‚úèÔ∏è</button>
                <button class="icon-btn" onclick="removerFixo('${nome.replace(/'/g,"\\'")}')">üóëÔ∏è</button>
            </div>
        </div>`).join('');
}

function abrirEditFixo(nome, catAtual) {
    editingFixoNome=nome;
    document.getElementById('editFixoNome').textContent=nome;
    document.getElementById('editFixoVal').value='';
    document.getElementById('editFixoFuturo').checked=false;
    const sel=document.getElementById('editFixoCat'); sel.innerHTML='';
    (cats['saida']||[]).forEach(c => { const o=document.createElement('option'); o.value=c; o.text=c; if(c===catAtual) o.selected=true; sel.add(o); });
    document.getElementById('ovEditFixo').classList.add('open');
}
function closeEditFixo(e) { if (!e||e.target===document.getElementById('ovEditFixo')) document.getElementById('ovEditFixo').classList.remove('open'); }

function confirmarEdicaoFixo() {
    const rawVal=document.getElementById('editFixoVal').value;
    const novoV=rawVal?parseFloat(rawVal.replace(',','.')):null;
    const novaCat=document.getElementById('editFixoCat').value;
    const futuro=document.getElementById('editFixoFuturo').checked;
    const {m:mesA,a:anoA}=filtro();
    if (rawVal&&(isNaN(novoV)||novoV<=0)) return toast('‚ö†Ô∏è Valor inv√°lido','#b45309');
    pushUndo(tx, `Edi√ß√£o do fixo "${editingFixoNome}"`);
    tx=tx.map(t => {
        if (t.desc===editingFixoNome&&t.fixo) {
            const dt=new Date(t.data+'T00:00:00');
            const applies=futuro?(dt.getFullYear()===anoA&&dt.getMonth()>=mesA):(dt.getFullYear()===anoA&&dt.getMonth()===mesA);
            if (applies) { if(novoV) t.valor=novoV; t.cat=novaCat; }
        }
        return t;
    });
    save(); atualizar(); renderPopupFixos(); closeEditFixo(); toast('‚úî Fixo atualizado!');
}

function removerFixo(nome) {
    const {m,a}=filtro();
    const futuro=confirm(`Remover "${nome}" dos meses futuros tamb√©m?`);
    pushUndo(tx, `Remo√ß√£o do fixo "${nome}"`);
    tx=tx.filter(t => {
        if (t.desc!==nome||!t.fixo) return true;
        const dt=new Date(t.data+'T00:00:00');
        if (futuro&&dt.getFullYear()===a&&dt.getMonth()>=m) return false;
        if (!futuro&&dt.getFullYear()===a&&dt.getMonth()===m) return false;
        return true;
    });
    save(); atualizar(); renderPopupFixos(); toast('Fixo removido.','#52525b');
}

// ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function adicionarCategoria() {
    const nome=document.getElementById('novaCat').value.trim(), tipo=document.getElementById('tipo').value;
    if (!nome) return;
    cats[tipo].push(nome);
    localStorage.setItem('fin5_cats',JSON.stringify(cats)); scheduleGhSave();
    document.getElementById('novaCat').value='';
    carregarCats(); renderCatList(); toast('Categoria adicionada!');
}
function removerCategoria(tipo, idx) {
    cats[tipo].splice(idx,1); localStorage.setItem('fin5_cats',JSON.stringify(cats)); scheduleGhSave(); carregarCats(); renderCatList();
}
function renderCatList() {
    const tipo=document.getElementById('tipo').value;
    document.getElementById('catList').innerHTML=(cats[tipo]||[]).map((c,i)=>`
        <div class="cat-item"><span>${c}</span><button class="icon-btn" onclick="removerCategoria('${tipo}',${i})">‚úï</button></div>`).join('')||'<span style="font-size:12px;color:var(--text-3)">Nenhuma.</span>';
}

// ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportar() {
    const b=new Blob([JSON.stringify({t:tx,c:cats,g:goals})],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup_finances.json'; a.click();
    toast('Exportado!');
}
function importar(input) {
    const r=new FileReader();
    r.onload=()=>{
        const d=JSON.parse(r.result);
        pushUndo(tx,'Importa√ß√£o');
        if(d.t) tx=d.t; if(d.c) cats=d.c; if(d.g) goals=d.g;
        save(); localStorage.setItem('fin5_cats',JSON.stringify(cats)); saveGoals();
        atualizar(); carregarCats(); renderCatList(); renderGoals(); toast('Importado!');
    };
    r.readAsText(input.files[0]);
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _openInlineId = null;

function renderTabela() {
    const {m,a}=filtro(), busca=document.getElementById('busca').value.toLowerCase();
    let lista=txMes(m,a).filter(t => {
        const matchTab  = activeTab==='all'||t.tipo===activeTab;
        const matchBusca= t.desc.toLowerCase().includes(busca)||t.cat.toLowerCase().includes(busca);
        return matchTab&&matchBusca;
    });
    lista=sorted(lista);
    const tbody=document.getElementById('tbody'), empty=document.getElementById('emptyState');
    if (!lista.length) { tbody.innerHTML=''; empty.style.display='block'; _openInlineId=null; return; }
    empty.style.display='none';

    const allCats = cats; // closure for inline selects

    tbody.innerHTML=lista.map(t => {
        const [y,mo,d]=t.data.split('-');
        const cor=t.tipo==='entrada'?'var(--success)':t.tipo==='investimento'?'var(--invest)':'var(--danger)';
        const pre=t.tipo==='entrada'?'+':'‚àí';
        const payTag=t.tipo==='saida'?(t.pagamento==='credito'?'<span class="tag-cred">CR√âD</span>':'<span class="tag-deb">D√âB</span>'):'';
        const isEditing = _openInlineId===t.id;

        // Build category options for inline select
        const tipoOpts = ['saida','entrada','investimento'].map(v=>`<option value="${v}" ${t.tipo===v?'selected':''}>${v==='saida'?'Gasto':v==='entrada'?'Ganho':'Investimento'}</option>`).join('');
        const catOpts = (allCats[t.tipo]||[]).map(c=>`<option value="${c}" ${t.cat===c?'selected':''}>${c}</option>`).join('');
        const pagOpts = ['debito','credito'].map(v=>`<option value="${v}" ${(t.pagamento||'debito')===v?'selected':''}>${v==='debito'?'D√©bito':'Cr√©dito'}</option>`).join('');

        return `<tr id="tr-${t.id}" class="${isEditing?'editing':''}">
            <td style="color:var(--text-3);font-size:12px;white-space:nowrap">${d}/${mo}</td>
            <td><span style="font-weight:500">${t.desc}</span>${payTag}${t.fixo?'<span class="tag-fixo">FIXO</span>':''}</td>
            <td style="font-size:12px;color:var(--text-3)">${t.cat}</td>
            <td style="font-weight:600;color:${cor};white-space:nowrap">${pre} ${fmt(t.valor)}</td>
            <td><div class="btn-row">
                <button class="icon-btn" title="Editar" onclick="openInlineEdit(${t.id})">‚úèÔ∏è</button>
                <button class="icon-btn" title="Remover" onclick="remover(${t.id})">üóëÔ∏è</button>
            </div></td>
        </tr>
        <tr id="ie-${t.id}" class="ie-row ${isEditing?'open':''}">
            <td colspan="5">
                <div class="ie-inner">
                    <div class="ie-field">
                        <label>Descri√ß√£o</label>
                        <input id="ie-desc-${t.id}" value="${t.desc.replace(/"/g,'&quot;')}" type="text">
                    </div>
                    <div class="ie-field">
                        <label>Valor (R$)</label>
                        <input id="ie-valor-${t.id}" value="${t.valor.toFixed(2).replace('.',',')}" type="text">
                    </div>
                    <div class="ie-field">
                        <label>Data</label>
                        <input id="ie-data-${t.id}" value="${t.data}" type="date">
                    </div>
                    <div class="ie-field">
                        <label>Tipo</label>
                        <select id="ie-tipo-${t.id}" onchange="ieUpdateCats(${t.id})">${tipoOpts}</select>
                    </div>
                    <div class="ie-field">
                        <label>Categoria</label>
                        <select id="ie-cat-${t.id}">${catOpts}</select>
                    </div>
                    <div class="ie-actions">
                        <button class="ie-save" onclick="saveInlineEdit(${t.id})">‚úî Salvar</button>
                        <button class="ie-cancel" onclick="closeInlineEdit()">‚úï</button>
                    </div>
                </div>
                <div style="display:flex;gap:20px;margin-top:8px">
                    <label class="ie-check">
                        <input type="checkbox" id="ie-fixo-${t.id}" ${t.fixo?'checked':''}>
                        Gasto fixo mensal
                    </label>
                    <div id="ie-pag-wrap-${t.id}" style="${t.tipo!=='saida'?'display:none':''}">
                        <label class="ie-check">Pagamento:&nbsp;
                            <select id="ie-pag-${t.id}" style="padding:2px 6px;border:1px solid var(--border);border-radius:5px;font-size:11px;font-family:Inter,sans-serif">${pagOpts}</select>
                        </label>
                    </div>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function openInlineEdit(id) {
    if (_openInlineId === id) { closeInlineEdit(); return; }
    // Close currently open if any
    if (_openInlineId) {
        const prevRow = document.getElementById('ie-'+_openInlineId);
        const prevTr  = document.getElementById('tr-'+_openInlineId);
        if (prevRow) prevRow.classList.remove('open');
        if (prevTr)  prevTr.classList.remove('editing');
    }
    _openInlineId = id;
    document.getElementById('ie-'+id).classList.add('open');
    document.getElementById('tr-'+id).classList.add('editing');
    document.getElementById('ie-desc-'+id).focus();
}

function closeInlineEdit() {
    if (!_openInlineId) return;
    const prevRow = document.getElementById('ie-'+_openInlineId);
    const prevTr  = document.getElementById('tr-'+_openInlineId);
    if (prevRow) prevRow.classList.remove('open');
    if (prevTr)  prevTr.classList.remove('editing');
    _openInlineId = null;
}

function ieUpdateCats(id) {
    const tipo = document.getElementById('ie-tipo-'+id).value;
    const catSel = document.getElementById('ie-cat-'+id);
    const pagWrap = document.getElementById('ie-pag-wrap-'+id);
    catSel.innerHTML = (cats[tipo]||[]).map(c=>`<option>${c}</option>`).join('');
    pagWrap.style.display = tipo==='saida' ? '' : 'none';
}

function saveInlineEdit(id) {
    const desc    = document.getElementById('ie-desc-'+id).value.trim();
    const valorRaw= document.getElementById('ie-valor-'+id).value.replace(/\./g,'').replace(',','.');
    const valor   = parseFloat(valorRaw);
    const data    = document.getElementById('ie-data-'+id).value;
    const tipo    = document.getElementById('ie-tipo-'+id).value;
    const cat     = document.getElementById('ie-cat-'+id).value;
    const fixo    = document.getElementById('ie-fixo-'+id).checked;
    const pagamento = tipo==='saida' ? document.getElementById('ie-pag-'+id).value : null;

    if (!desc)               return toast('‚ö†Ô∏è Descri√ß√£o vazia.','#b45309');
    if (isNaN(valor)||valor<=0) return toast('‚ö†Ô∏è Valor inv√°lido.','#b45309');
    if (!data)               return toast('‚ö†Ô∏è Data inv√°lida.','#b45309');

    const oldT = tx.find(t=>t.id==id);
    pushUndo(tx, `Edi√ß√£o de "${desc}"`);
    tx = tx.map(t => t.id==id ? {...t,desc,valor,data,tipo,cat,fixo,pagamento} : t);
    closeInlineEdit();

    // If fixo was newly switched on, offer replication via modal
    if (fixo && !oldT.fixo) {
        _pendingFixo = {desc,valor,data,tipo,cat,pagamento,afterEditId:id};
        document.getElementById('fixoRepMsg').textContent = `"${desc}" foi marcado como fixo. Replicar para os pr√≥ximos meses?`;
        document.getElementById('ovFixoRep').classList.add('open');
        return;
    }

    save(); atualizar();
    toast('‚úî Atualizado!');
}

// ‚îÄ‚îÄ CHARTS (DASHBOARD) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDonut(dados, cid, wid, emptyIcon, colors, emptyH=160) {
    const wrap=document.getElementById(wid), keys=Object.keys(dados);
    if (!keys.length) {
        wrap.innerHTML=`<div class="chart-empty" style="height:${emptyH}px"><span style="font-size:24px;opacity:.3">${emptyIcon}</span>Sem dados</div>`;
        if(charts[cid]){charts[cid].destroy();delete charts[cid];}
        return;
    }
    wrap.innerHTML=`<div style="height:${emptyH}px;position:relative"><canvas id="${cid}"></canvas></div>`;
    const ctx=document.getElementById(cid).getContext('2d');
    if(charts[cid]) charts[cid].destroy();
    charts[cid]=new Chart(ctx,{
        type:'doughnut',
        data:{labels:keys,datasets:[{data:Object.values(dados),backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:8,font:{size:10,family:'Inter'},padding:8}}},cutout:'65%'}
    });
}

function renderTrend() {
    const now=new Date(), labels=[], ent=[], gas=[], inv=[];
    for(let i=5;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1);
        labels.push(MESES[d.getMonth()].slice(0,3));
        const l=txMes(d.getMonth(),d.getFullYear());
        ent.push(l.filter(t=>t.tipo==='entrada').reduce((s,t)=>s+t.valor,0));
        gas.push(l.filter(t=>t.tipo==='saida').reduce((s,t)=>s+t.valor,0));
        inv.push(l.filter(t=>t.tipo==='investimento').reduce((s,t)=>s+t.valor,0));
    }
    const ctx=document.getElementById('graficoTrend').getContext('2d');
    if(charts['trend']) charts['trend'].destroy();
    charts['trend']=new Chart(ctx,{
        type:'bar',
        data:{labels,datasets:[
            {label:'Entradas',data:ent,backgroundColor:'#dcfce7',borderColor:'#16a34a',borderWidth:1.5,borderRadius:3},
            {label:'Gastos',  data:gas,backgroundColor:'#fee2e2',borderColor:'#dc2626',borderWidth:1.5,borderRadius:3},
            {label:'Invest.', data:inv,backgroundColor:'#ede9fe',borderColor:'#6d28d9',borderWidth:1.5,borderRadius:3}
        ]},
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{boxWidth:8,font:{size:10,family:'Inter'},padding:8}}},
            scales:{x:{grid:{display:false},ticks:{font:{size:10,family:'Inter'}}},y:{grid:{color:'#f4f4f5'},ticks:{font:{size:9},callback:v=>'R$'+(v>=1000?(v/1000).toFixed(1)+'k':v)}}}}
    });
}

// ‚îÄ‚îÄ MAIN UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function atualizar() {
    const {m,a}=filtro(), lista=txMes(m,a);
    let ent=0,gas=0,inv=0;
    const catD={},catI={},fixosMap={},fixosCat={};
    lista.forEach(t=>{
        if(t.tipo==='entrada') ent+=t.valor;
        else if(t.tipo==='investimento'){inv+=t.valor; catI[t.cat]=(catI[t.cat]||0)+t.valor;}
        else{gas+=t.valor; catD[t.cat]=(catD[t.cat]||0)+t.valor;}
        if(t.fixo){fixosMap[t.desc]=(fixosMap[t.desc]||0)+t.valor; fixosCat[t.desc]=t.cat;}
    });
    const saldo=ent-gas-inv;
    document.getElementById('kpiEnt').textContent=fmt(ent);
    document.getElementById('kpiGas').textContent=fmt(gas);
    document.getElementById('kpiInv').textContent=fmt(inv);
    const kpiSal=document.getElementById('kpiSal');
    kpiSal.textContent=fmt(saldo); kpiSal.className='kpi-val '+(saldo<0?'red':'dark');
    document.getElementById('kpiGasSub').textContent=ent>0?`${Math.round((gas/ent)*100)}% da renda`:'';
    const sw=document.getElementById('savingsWrap');
    if(ent>0){
        const pct=Math.max(0,Math.round(((ent-gas)/ent)*100));
        sw.style.display='block';
        document.getElementById('savingsLabel').textContent=`${pct}% poupado`;
        document.getElementById('savingsFill').style.width=Math.min(pct,100)+'%';
    } else sw.style.display='none';
    document.getElementById('pillMes').textContent=MESES[m]+' '+a;
    const nomes=Object.keys(fixosMap), totalF=Object.values(fixosMap).reduce((s,v)=>s+v,0);
    document.getElementById('fixosMiniTotal').textContent=nomes.length?fmt(totalF):'';
    document.getElementById('fixosMiniList').innerHTML=nomes.length
        ? nomes.sort((a,b)=>fixosMap[b]-fixosMap[a]).slice(0,5).map(n=>`
            <div class="fixos-mini-item"><span class="n">${n}</span><span class="v">${fmt(fixosMap[n])}</span></div>`).join('')
            +(nomes.length>5?`<div style="text-align:center;margin-top:6px"><button class="link-btn" onclick="abrirPopupFixos()">ver todos (${nomes.length})</button></div>`:'')
        : '<span style="font-size:12px;color:var(--text-3)">Nenhum fixo.</span>';
    renderDonut(catD,'grafGas','wrapGastos','üìâ',CAT_COLORS);
    renderDonut(catI,'grafInv','wrapInvest','üíº',['#6d28d9','#7c3aed','#a78bfa','#c4b5fd']);
    renderTrend(); renderTabela();
}

// ‚îÄ‚îÄ ANNUAL VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAnual() {
    const a=parseInt(document.getElementById('filtroAno').value);
    document.getElementById('anualSubtitle').textContent=`Resumo completo de ${a}`;
    let aEnt=0, aGas=0, aInv=0, aCred=0, aDeb=0;
    const catAnual={};
    const rows=[];
    for (let m=0; m<12; m++) {
        const lista=txMes(m,a);
        let ent=0,gas=0,inv=0,cred=0,deb=0;
        lista.forEach(t=>{
            if(t.tipo==='entrada') ent+=t.valor;
            else if(t.tipo==='investimento') inv+=t.valor;
            else { gas+=t.valor; catAnual[t.cat]=(catAnual[t.cat]||0)+t.valor; if(t.pagamento==='credito') cred+=t.valor; else deb+=t.valor; }
        });
        aEnt+=ent; aGas+=gas; aInv+=inv; aCred+=cred; aDeb+=deb;
        rows.push({m,ent,gas,inv,cred,deb,saldo:ent-gas-inv});
    }
    const aSaldo=aEnt-aGas-aInv;
    document.getElementById('aKpiEnt').textContent=fmt(aEnt);
    document.getElementById('aKpiGas').textContent=fmt(aGas);
    document.getElementById('aKpiInv').textContent=fmt(aInv);
    document.getElementById('aKpiDeb').textContent=fmt(aDeb);
    document.getElementById('aKpiCred').textContent=fmt(aCred);
    document.getElementById('aKpiSaldo').textContent=fmt(aSaldo);
    document.getElementById('aKpiSaldo').className='kpi-val '+(aSaldo<0?'red':'dark');
    document.getElementById('aKpiDebPct').textContent=aGas>0?`${Math.round((aDeb/aGas)*100)}% das despesas`:'';
    document.getElementById('aKpiCredPct').textContent=aGas>0?`${Math.round((aCred/aGas)*100)}% das despesas`:'';

    // Annual bar chart
    const ctx=document.getElementById('graficoAnual').getContext('2d');
    if(charts['anual']) charts['anual'].destroy();
    charts['anual']=new Chart(ctx,{
        type:'bar',
        data:{
            labels:MESES.map(m=>m.slice(0,3)),
            datasets:[
                {label:'Entradas',data:rows.map(r=>r.ent),backgroundColor:'#dcfce7',borderColor:'#16a34a',borderWidth:1.5,borderRadius:3},
                {label:'D√©bito',  data:rows.map(r=>r.deb),backgroundColor:'#ccfbf1',borderColor:'#0f766e',borderWidth:1.5,borderRadius:3},
                {label:'Cr√©dito', data:rows.map(r=>r.cred),backgroundColor:'#e0f2fe',borderColor:'#0284c7',borderWidth:1.5,borderRadius:3},
                {label:'Invest.', data:rows.map(r=>r.inv),backgroundColor:'#ede9fe',borderColor:'#6d28d9',borderWidth:1.5,borderRadius:3}
            ]
        },
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{boxWidth:8,font:{size:10,family:'Inter'},padding:8}}},
            scales:{x:{grid:{display:false},ticks:{font:{size:10,family:'Inter'}}},y:{grid:{color:'#f4f4f5'},ticks:{font:{size:9},callback:v=>'R$'+(v>=1000?(v/1000).toFixed(1)+'k':v)}}}}
    });

    renderDonut(catAnual,'grafAnualCat','wrapAnualCat','üìâ',CAT_COLORS,240);

    // Month table
    document.getElementById('anualTbody').innerHTML=rows.map(r=>{
        const hasData=r.ent||r.gas||r.inv;
        const sc=r.saldo>=0?'green-val':'red-val';
        return `<tr class="${hasData?'clickable':''}" onclick="${hasData?`goToMensal(${r.m},${a})`:''}">
            <td>${MESES[r.m]}</td>
            <td class="green-val">${r.ent?fmt(r.ent):'‚Äî'}</td>
            <td class="teal-val">${r.deb?fmt(r.deb):'‚Äî'}</td>
            <td class="blue-val">${r.cred?fmt(r.cred):'‚Äî'}</td>
            <td class="purple-val">${r.inv?fmt(r.inv):'‚Äî'}</td>
            <td class="${hasData?sc:''}"> ${hasData?fmt(r.saldo):'‚Äî'}</td>
        </tr>`;
    }).join('');
}

// ‚îÄ‚îÄ MONTHLY ANALYSIS VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMensal() {
    const m=parseInt(document.getElementById('mensalMes').value);
    const a=parseInt(document.getElementById('mensalAno').value);
    const lista=txMes(m,a);
    const saidas=lista.filter(t=>t.tipo==='saida');
    const debItems=saidas.filter(t=>t.pagamento!=='credito');
    const credItems=saidas.filter(t=>t.pagamento==='credito');
    let ent=0,gas=0,cred=0,deb=0,inv=0;
    lista.forEach(t=>{
        if(t.tipo==='entrada') ent+=t.valor;
        else if(t.tipo==='investimento') inv+=t.valor;
        else { gas+=t.valor; if(t.pagamento==='credito') cred+=t.valor; else deb+=t.valor; }
    });
    document.getElementById('mKpiEnt').textContent=fmt(ent);
    document.getElementById('mKpiGas').textContent=fmt(gas);
    document.getElementById('mKpiCred').textContent=fmt(cred);
    document.getElementById('mKpiDeb').textContent=fmt(deb);
    document.getElementById('mKpiGasSub').textContent=ent>0?`${Math.round((gas/ent)*100)}% da renda`:'';
    document.getElementById('mDebTotal').textContent=fmt(deb);
    document.getElementById('mCredTotal').textContent=fmt(cred);

    function renderSplitList(items, containerId) {
        const el=document.getElementById(containerId);
        if (!items.length) { el.innerHTML='<div class="split-empty">Nenhum lan√ßamento.</div>'; return; }
        el.innerHTML=[...items].sort((a,b)=>b.valor-a.valor).map(t=>{
            const [y,mo,d]=t.data.split('-');
            return `<div class="split-item">
                <div>
                    <div class="split-item-desc">${t.desc}${t.fixo?'<span class="tag-fixo">FIXO</span>':''}</div>
                    <div class="split-item-meta">${d}/${mo} ¬∑ ${t.cat}</div>
                </div>
                <div class="split-item-val">‚àí ${fmt(t.valor)}</div>
            </div>`;
        }).join('');
    }
    renderSplitList(debItems,'mDebList');
    renderSplitList(credItems,'mCredList');

    // Day spending chart
    const daysInMonth=new Date(a,m+1,0).getDate();
    const dayData=Array(daysInMonth).fill(0);
    saidas.forEach(t=>{ const d=parseInt(t.data.split('-')[2])-1; dayData[d]+=t.valor; });
    const ctxDia=document.getElementById('graficoDia').getContext('2d');
    if(charts['dia']) charts['dia'].destroy();
    charts['dia']=new Chart(ctxDia,{
        type:'bar',
        data:{labels:Array.from({length:daysInMonth},(_,i)=>i+1),datasets:[{label:'Gastos',data:dayData,backgroundColor:'#fee2e2',borderColor:'#dc2626',borderWidth:1.5,borderRadius:2}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{size:9},maxTicksLimit:16}},y:{grid:{color:'#f4f4f5'},ticks:{font:{size:9},callback:v=>'R$'+(v>=1000?(v/1000).toFixed(1)+'k':v)}}}}
    });

    // Credit vs Debit donut
    const ctxCvD=document.getElementById('graficoCvD').getContext('2d');
    if(charts['cvd']) charts['cvd'].destroy();
    if (gas>0) {
        charts['cvd']=new Chart(ctxCvD,{
            type:'doughnut',
            data:{labels:['D√©bito','Cr√©dito'],datasets:[{data:[deb,cred],backgroundColor:['#ccfbf1','#e0f2fe'],borderColor:['#0f766e','#0284c7'],borderWidth:2}]},
            options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:8,font:{size:10,family:'Inter'},padding:8}}},cutout:'65%'}
        });
    } else {
        ctxCvD.canvas.parentElement.innerHTML='<div style="height:200px;display:flex;align-items:center;justify-content:center;color:var(--text-3);font-size:12px">Sem despesas</div>';
    }

    // Category breakdown
    const catMap={};
    saidas.forEach(t=>{ catMap[t.cat]=(catMap[t.cat]||0)+t.valor; });
    const sorted2=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
    const maxVal=sorted2[0]?.[1]||1;
    document.getElementById('catBreakdownList').innerHTML=sorted2.length
        ? sorted2.map(([cat,val],i)=>`
            <div class="cat-bar-row">
                <div class="cat-bar-name" title="${cat}">${cat}</div>
                <div class="cat-bar-track"><div class="cat-bar-fill" style="width:${Math.round((val/maxVal)*100)}%;background:${CAT_COLORS[i%CAT_COLORS.length]}"></div></div>
                <div class="cat-bar-pct">${gas>0?Math.round((val/gas)*100):0}%</div>
                <div class="cat-bar-val">${fmt(val)}</div>
            </div>`).join('')
        : '<div class="split-empty">Sem gastos neste m√™s.</div>';
}

// ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGoals() {
    const grid=document.getElementById('goalsGrid');
    grid.innerHTML=goals.map(g=>{
        const atual=g.aportes.reduce((s,a)=>s+a.valor,0);
        const pct=Math.min(100,Math.round((atual/g.meta)*100));
        const prazoStr=g.prazo?new Date(g.prazo+'T00:00:00').toLocaleDateString('pt-BR',{month:'short',year:'numeric'}):'Sem prazo';
        const aportesList=g.aportes.slice().reverse().map(a=>`
            <div class="aporte-item">
                <span>${new Date(a.data+'T00:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})}${a.nota?' ¬∑ '+a.nota:''}</span>
                <span style="font-weight:600;color:var(--success)">+${fmt(a.valor)}</span>
            </div>`).join('');
        const faltam=g.meta-atual;
        return `
        <div class="goal-card">
            <div class="goal-accent" style="background:${g.cor}"></div>
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:10px">
                <div class="goal-name" style="margin-top:0">${g.nome}</div>
                <div class="goal-actions">
                    <button class="icon-btn" onclick="editarGoal(${g.id})" title="Editar">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="removerGoal(${g.id})" title="Remover">üóëÔ∏è</button>
                </div>
            </div>
            <div class="goal-desc">${g.descricao||'&nbsp;'}</div>
            <div class="goal-amounts">
                <div class="goal-atual" style="color:${g.cor}">${fmt(atual)}</div>
                <div class="goal-target">de ${fmt(g.meta)}</div>
            </div>
            <div class="goal-track">
                <div class="goal-fill" style="width:${pct}%;background:${g.cor}"></div>
            </div>
            <div class="goal-meta-row">
                <span class="goal-pct" style="color:${g.cor}">${pct}% conclu√≠do</span>
                <span>${pct<100?'Faltam '+fmt(faltam):'‚úî Conclu√≠do!'}</span>
            </div>
            <div style="font-size:11px;color:var(--text-3);margin-bottom:12px">üìÖ Prazo: ${prazoStr}</div>
            <button class="btn-aporte" style="background:${g.cor}" onclick="abrirAporte(${g.id})">+ Adicionar Aporte</button>
            ${g.aportes.length?`
                <button class="goal-hist-toggle" onclick="toggleHistory(this)">Ver hist√≥rico (${g.aportes.length} aportes)</button>
                <div class="goal-history">${aportesList}</div>
            `:''}
        </div>`;
    }).join('')+`
    <div class="goal-add-card" onclick="abrirNovaGoal()">
        <span style="font-size:32px;opacity:0.25">Ôºã</span>
        <span style="font-size:13px;font-weight:500">Nova Meta</span>
    </div>`;
}

function toggleHistory(btn) {
    const hist=btn.nextElementSibling;
    hist.classList.toggle('open');
    const count=hist.querySelectorAll('.aporte-item').length;
    btn.textContent=hist.classList.contains('open')?'Ocultar hist√≥rico':`Ver hist√≥rico (${count} aportes)`;
}

function renderColorPicker() {
    document.getElementById('colorPicker').innerHTML=GOAL_COLORS.map(c=>`
        <div class="color-opt ${c===selectedGoalColor?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>
    `).join('');
}
function selectColor(c) {
    selectedGoalColor=c;
    document.querySelectorAll('.color-opt').forEach(el=>{ el.classList.toggle('selected', el.style.backgroundColor===hexToRgb(c)||el.style.background===c); });
    renderColorPicker();
}
function hexToRgb(hex) {
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    return `rgb(${r}, ${g}, ${b})`;
}

function abrirNovaGoal() {
    document.getElementById('goalModalTitle').textContent='Nova Meta';
    document.getElementById('goalEditId').value='';
    document.getElementById('goalNome').value='';
    document.getElementById('goalMeta').value='';
    document.getElementById('goalDesc').value='';
    document.getElementById('goalPrazo').value='';
    selectedGoalColor=GOAL_COLORS[0];
    renderColorPicker();
    document.getElementById('ovNovaGoal').classList.add('open');
}
function editarGoal(id) {
    const g=goals.find(x=>x.id===id);
    document.getElementById('goalModalTitle').textContent='Editar Meta';
    document.getElementById('goalEditId').value=id;
    document.getElementById('goalNome').value=g.nome;
    document.getElementById('goalMeta').value=g.meta;
    document.getElementById('goalDesc').value=g.descricao||'';
    document.getElementById('goalPrazo').value=g.prazo||'';
    selectedGoalColor=g.cor;
    renderColorPicker();
    document.getElementById('ovNovaGoal').classList.add('open');
}
function closeNovaGoal(e) { if(!e||e.target===document.getElementById('ovNovaGoal')) document.getElementById('ovNovaGoal').classList.remove('open'); }

function salvarGoal() {
    const nome=document.getElementById('goalNome').value.trim();
    const meta=parseFloat(document.getElementById('goalMeta').value);
    const prazo=document.getElementById('goalPrazo').value;
    const descricao=document.getElementById('goalDesc').value.trim();
    const editId=document.getElementById('goalEditId').value;
    if (!nome) return toast('‚ö†Ô∏è Digite um nome.','#b45309');
    if (!meta||meta<=0) return toast('‚ö†Ô∏è Valor alvo inv√°lido.','#b45309');
    if (editId) {
        const idx=goals.findIndex(g=>g.id==editId);
        goals[idx]={...goals[idx],nome,meta,prazo,descricao,cor:selectedGoalColor};
        toast('‚úî Meta atualizada!');
    } else {
        goals.push({id:Date.now(),nome,meta,prazo,descricao,cor:selectedGoalColor,aportes:[]});
        toast('üéØ Meta criada!');
    }
    saveGoals(); renderGoals(); closeNovaGoal();
}

function removerGoal(id) {
    const g=goals.find(x=>x.id===id);
    if (!confirm(`Remover a meta "${g.nome}"?`)) return;
    goals=goals.filter(x=>x.id!==id);
    saveGoals(); renderGoals(); toast('Meta removida.','#52525b');
}

function abrirAporte(id) {
    const g=goals.find(x=>x.id===id);
    document.getElementById('aporteGoalId').value=id;
    document.getElementById('aporteGoalNome').textContent=g.nome;
    document.getElementById('aporteValor').value='';
    document.getElementById('aporteNota').value='';
    document.getElementById('aporteData').valueAsDate=new Date();
    document.getElementById('ovAporte').classList.add('open');
}
function closeAporte(e) { if(!e||e.target===document.getElementById('ovAporte')) document.getElementById('ovAporte').classList.remove('open'); }

function confirmarAporte() {
    const id=parseInt(document.getElementById('aporteGoalId').value);
    const valor=parseFloat(document.getElementById('aporteValor').value);
    const data=document.getElementById('aporteData').value;
    const nota=document.getElementById('aporteNota').value.trim();
    if (!valor||valor<=0) return toast('‚ö†Ô∏è Valor inv√°lido.','#b45309');
    if (!data) return toast('‚ö†Ô∏è Selecione uma data.','#b45309');
    const idx=goals.findIndex(g=>g.id===id);
    goals[idx].aportes.push({valor,data,nota});
    saveGoals(); renderGoals(); closeAporte();
    toast(`‚úî Aporte de ${fmt(valor)} adicionado!`,'#16a34a');
}


// ‚îÄ‚îÄ GITHUB SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GH_CFG_KEY = 'fin5_gh_config';

function getGhCfg() {
    try { return JSON.parse(localStorage.getItem(GH_CFG_KEY)) || {}; } catch { return {}; }
}
function saveGhCfgToStorage(cfg) {
    localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg));
}

let _ghSyncing = false;
let _ghConfigOpen = false;

function setGhStatus(state, text) {
    const dot = document.getElementById('ghDot');
    const txt = document.getElementById('ghStatusText');
    dot.className = 'gh-dot ' + state;
    txt.textContent = text;
}

function updateLastSync(ts) {
    const el = document.getElementById('ghLastSync');
    if (!ts) { el.textContent = ''; return; }
    el.textContent = '√öltima sync: ' + new Date(ts).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
}

function toggleGhConfig() {
    _ghConfigOpen = !_ghConfigOpen;
    document.getElementById('ghConfig').classList.toggle('open', _ghConfigOpen);
    if (_ghConfigOpen) {
        const s = getGhCfg();
        document.getElementById('ghRepo').value  = s.repo  || '';
        document.getElementById('ghToken').value = s.token || '';
        document.getElementById('ghFile').value  = s.file  || 'finances-data.json';
    }
}

function saveGhConfig() {
    const repo  = document.getElementById('ghRepo').value.trim();
    const token = document.getElementById('ghToken').value.trim();
    const file  = document.getElementById('ghFile').value.trim() || 'finances-data.json';
    if (!repo || !token) return toast('‚ö†Ô∏è Preencha reposit√≥rio e token.', '#b45309');
    saveGhCfgToStorage({repo, token, file});
    toggleGhConfig();
    toast('‚úî Configura√ß√£o salva!');
    setGhStatus('idle', 'Conectado ¬∑ ' + repo);
    syncNow();
}

function initGhStatus() {
    const cfg = getGhCfg();
    setGhStatus('idle', cfg.repo && cfg.token ? 'Conectado ¬∑ ' + cfg.repo : 'N√£o configurado');
    if (cfg.lastSync) updateLastSync(cfg.lastSync);
}

// ‚îÄ‚îÄ Encoding helpers (suporte total a emojis e acentos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// btoa/atob nativos s√≥ suportam Latin-1 ‚Äî usamos TextEncoder/TextDecoder
function toBase64(str) {
    const bytes = new TextEncoder().encode(str);
    let bin = '';
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
}
function fromBase64(b64) {
    const bin   = atob(b64.replace(/\n/g, ''));
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder().decode(bytes);
}

// ‚îÄ‚îÄ URLs e headers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ghUrlWrite() {
    const cfg = getGhCfg();
    if (!cfg.repo || !cfg.token) return null;
    return `https://api.github.com/repos/${cfg.repo}/contents/${cfg.file || 'finances-data.json'}`;
}
function ghUrlRead() {
    const url = ghUrlWrite();
    return url ? `${url}?_=${Date.now()}` : null; // cache-bust s√≥ no GET
}
function ghHeaders(isWrite = false) {
    const h = { 'Authorization': 'token ' + getGhCfg().token, 'Accept': 'application/vnd.github.v3+json' };
    if (!isWrite) h['Cache-Control'] = 'no-cache';
    if (isWrite)  h['Content-Type']  = 'application/json';
    return h;
}

// ‚îÄ‚îÄ Busca SHA atual (necess√°rio para sobrescrever arquivo existente) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchCurrentSha() {
    const res = await fetch(ghUrlRead(), { headers: ghHeaders(false) });
    if (res.status === 404) return null;       // arquivo ainda n√£o existe
    if (!res.ok) throw new Error('Erro ao ler SHA: HTTP ' + res.status);
    return (await res.json()).sha;
}

// ‚îÄ‚îÄ Download: GitHub ‚Üí local (sem disparar re-upload) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pullFromGitHub() {
    const url = ghUrlRead();
    if (!url) return false;
    const res = await fetch(url, { headers: ghHeaders(false) });
    if (res.status === 404) return false;
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    const raw  = JSON.parse(fromBase64(json.content)); // decode UTF-8 correto
    if (raw.t) { tx    = raw.t.map(t => ({pagamento: t.tipo==='saida'?'debito':null,...t})); localStorage.setItem('fin5_data',  JSON.stringify(tx)); }
    if (raw.c) { cats  = raw.c;  localStorage.setItem('fin5_cats',  JSON.stringify(cats)); }
    if (raw.g) { goals = raw.g;  localStorage.setItem('fin5_goals', JSON.stringify(goals)); }
    return true;
}

// ‚îÄ‚îÄ Upload: local ‚Üí GitHub ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Mutex: s√≥ um push por vez. Se j√° estiver rodando, re-agenda para depois.
let _pushing = false;
async function pushToGitHub() {
    if (_pushing) return;                      // evita uploads concorrentes
    const url = ghUrlWrite();
    if (!url) return;
    _pushing = true;
    try {
        const sha     = await fetchCurrentSha(); // sempre pega SHA atual
        const json    = JSON.stringify({ t: tx, c: cats, g: goals }, null, 2);
        const content = toBase64(json);          // encode UTF-8 correto
        const body    = { message: 'üí∞ ' + new Date().toLocaleString('pt-BR'), content };
        if (sha) body.sha = sha;                 // necess√°rio para atualizar arquivo existente

        const res = await fetch(url, {
            method: 'PUT',
            headers: ghHeaders(true),
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || 'HTTP ' + res.status);
        }
    } finally {
        _pushing = false;
    }
}

// ‚îÄ‚îÄ Sincronizar (bot√£o): push ‚Üí pull ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncNow() {
    const cfg = getGhCfg();
    if (!cfg.repo || !cfg.token) { toggleGhConfig(); return; }
    if (_ghSyncing) return;
    _ghSyncing = true;
    setGhStatus('syncing', 'Sincronizando...');
    try {
        await pushToGitHub();
        const pulled = await pullFromGitHub();
        const now = Date.now();
        saveGhCfgToStorage({...cfg, lastSync: now});
        updateLastSync(now);
        atualizar(); renderGoals();
        setGhStatus('ok', 'Sincronizado ¬∑ ' + cfg.repo);
        toast(pulled ? '‚òÅÔ∏è Sincronizado!' : '‚òÅÔ∏è Dados enviados!', '#16a34a');
    } catch(e) {
        setGhStatus('err', 'Erro na sync');
        toast('‚ùå Sync: ' + e.message, '#dc2626');
    } finally {
        _ghSyncing = false;
    }
}

// ‚îÄ‚îÄ Auto-save: debounced ‚Äî salva 2s ap√≥s √∫ltima altera√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _ghSaveTimer = null;
function scheduleGhSave() {
    clearTimeout(_ghSaveTimer);
    _ghSaveTimer = setTimeout(async () => {
        const cfg = getGhCfg();
        if (!cfg.repo || !cfg.token) return; // n√£o configurado, ignora silenciosamente
        setGhStatus('syncing', 'Salvando...');
        try {
            await pushToGitHub();
            const now = Date.now();
            saveGhCfgToStorage({...cfg, lastSync: now});
            updateLastSync(now);
            setGhStatus('ok', 'Salvo ¬∑ ' + cfg.repo);
        } catch(e) {
            setGhStatus('err', 'Erro ao salvar');
            toast('‚ùå Erro ao salvar no GitHub: ' + e.message, '#dc2626');
        }
    }, 2000);
}

// ‚îÄ‚îÄ Inicializa√ß√£o: carrega dados do GitHub ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromGitHub() {
    const cfg = getGhCfg();
    if (!cfg.repo || !cfg.token) return;
    setGhStatus('syncing', 'Carregando...');
    try {
        const pulled = await pullFromGitHub();
        if (pulled) {
            const now = Date.now();
            saveGhCfgToStorage({...cfg, lastSync: now});
            updateLastSync(now);
            atualizar(); renderGoals();
            toast('‚òÅÔ∏è Dados carregados do GitHub!', '#16a34a');
        }
        setGhStatus('ok', 'Conectado ¬∑ ' + cfg.repo);
    } catch(e) {
        setGhStatus('err', 'Erro ao carregar');
        toast('‚ùå GitHub: ' + e.message, '#dc2626');
    }
}

init();
</script>
</body>
</html>
